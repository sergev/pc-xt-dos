# install - device containing MKS Toolkit installation
# root: - where MKS Toolkit will end up
# boot - the device that DOS is booted from (config.sys, autoexec.bat)
# dist - the floppy that the Toolkit is read from

dist = 0;
toolkit_version = "4.1";
toolkit_os = "DOS";

#
# print out the basic screen information
#
displayline(0, 0, NORMAL, "Mortice Kern Systems Inc.");
displayline(LINES-1, CENTER, NORMAL, COPYRIGHT);
displayline(0, CENTER, NORMAL, "Configure V1.3");
displayline(0, RIGHT, NORMAL, "Product Configuration");
displayline(LINES-3, CENTER, NORMAL, "Press Control-C or Control-Break to exit.");
clearline(3);
displayline(3, -1, BOLD, "MKS Toolkit");
clearline(4);
displayline(4, -1, NORMAL, "Version "|toolkit_version|" for "|toolkit_os);
clearline(6);
redraw();

maildir = "";
rmail = "";

function Add_User() 
{
	username = "";
	while (username == "") do
		username = ask("",
			"Enter login name for new user:",
			"(no spaces, max 8 characters)");
		if (username == "")
			return (0);
		fi
		if (search(etcpasswd, 1, username))
			notify(username, "is already in the password file.");
			username = "";
		fi
	done
	user = ask("", "Enter real name for "|username|":", "(first last)");
	home = "";
	while (home == "") do
		home = ask(root | "/" | username,
			   "Enter home directory for "|username|":");
		if (length(home) == 2 && substr(home, 2, 1) == ":")
			notify("Please specify a full directory name",
			       "including drive letter, colon and",
			       "leading backslash.");
			home = "";
		elif (substr(home, 2, 1) != ":")
			notify("Please specify a full directory name",
			       "including drive letter, colon and",
			       "leading backslash.");
			home = "";
		fi
	done
	if (stat(home, 1))
		homedir_exists = 1;
	else
		homedir_exists = mktree(home);
	fi
	if (homedir_exists)
		append(etcpasswd,
		       username | ";;0;0;" | user | ";" |
			home | ";" | root | "/bin/sh.exe -0 " |
			root | "/bin/sh.exe -R 0");
		if (!stat(home | "/profile.ksh", 0))
			if (stat(profile_ksh, 0))
				simple_copy(profile_ksh, home|"/profile.ksh",
				    "Cannot install default profile.ksh.");
			fi
		fi
		if (!stat(home | "/environ.ksh", 0))
			if (stat(environ_ksh, 0))
				simple_copy(environ_ksh, home|"/environ.ksh",
				    "Cannot install default environ.ksh.");
			fi
		fi
	fi
}

function Delete_User()
{
	username = ask("", "Enter login name of user to be removed:");
	if (username == "")
		return (0);
	fi
	if (!search(etcpasswd, 1, username))
		notify(username, "is not in the password file.");
	else
		dellines(etcpasswd, username);
	fi
}

function Mail_Configuration()
{
# Set up MAILDIR if it's not root/usr/mail
	maildir = getenv("MAILDIR");
	while (maildir == "") do
		if (stat(root | "/bin/rmail.exe", 0))
			rmail = root|"/etc/rmail.rc";
			maildir = ask(root|"/usr/mail",
			  "mailx.exe and rmail.exe expect mail to be kept in",
			  root|"/usr/mail",
			  "If you choose to not use the above value",
			  "then MAILDIR will be set to this name.\n");
		else
			maildir = ask(root | "/usr/mail",
			  "mailx.exe expects mail to be kept in",
			  root|"/usr/mail",
			  "If you choose to not use the above value",
			  "then MAILDIR will be set to this name.\n");
		fi
		if (length(maildir) == 2 && substr(maildir, 2, 1) == ":")
			notify("Please specify a full directory name",
			       "including drive letter, colon and",
			       "leading backslash.");
			maildir = "";
		elif (substr(maildir, 2, 1) != ":")
			notify("Please specify a full directory name",
			       "including drive letter, colon and",
			       "leading backslash.");
			maildir = "";
		fi
		if (!mktree(maildir))
			notify("Could not create " | maildir | ".",
			       "Please try again.");
			maildir = "";
		fi
	done
	if (maildir == root|"/usr/mail")
		maildir = "";
		rmail = "";
	fi
	# If it is a non-standard maildir, add MAILDIR to autoexec,
	# etc/profile.ksh and (if appropriate) etc/rmail.rc.
	if (maildir != "")
		qreplace(autoexec, "MAILDIR=", "set MAILDIR="|maildir);
		qreplace(etcprofile, "MAILDIR=", "export MAILDIR="|maildir);
		if (rmail != "")
			qadd(rmail, "MAILDIR", "MAILDIR "|maildir);
		fi
	fi
}

function MKS_Make_Configuration()
{
	config = select("Select a compiler:\n",
			"  ~< 1 ~>  Borland C++ 3.0 or 3.1",
			"  ~< 2 ~>  Microsoft C 6.0 or C/C++ 7.0",
			"  ~< 3 ~>  Turbo C 1.5 or 2.0",
			"  ~< 4 ~>  Watcom C/386 9.0",
			"  ~< 5 ~>  Watcom C 9.0",
			"  ~< 6 ~>  Zortech C++ 3.0",
			"  ~< 7 ~>  Exit MKS Make Configuration");
	if (config == 1)
		compiler = "borlandc";
	elif (config == 2)
		compiler = "msc";
	elif (config == 3)
		compiler = "turboc";
	elif (config == 4)
		compiler = "watc386";
	elif (config == 5)
		compiler = "watcomc";
	elif (config == 6)
		compiler = "zortech";
	else
		return (1);
	fi

	compiler_ccg = root | "/etc/compiler.ccg";
	startup_mk   = root | "/etc/startup.mk";
	new_compiler_ccg = root | "/etc/" | compiler | ".ccg";
	new_startup_mk   = root | "/etc/" | compiler | ".mk";

	if (!stat(new_compiler_ccg, 0))
		notify("Error while checking existence of file",
		       new_compiler_ccg,
		       syserr(),
		       "",
		       "MKS Make configuration aborting.");
		return (0);
	fi
	if (!stat(new_startup_mk, 0))
		notify("Error while checking existence of file",
		       new_startup_mk,
		       syserr(),
		       "",
		       "MKS Make configuration aborting.");
		return (0);
	fi
	if (stat(compiler_ccg, 0))
		if (!simple_copy(compiler_ccg, root | "/etc/compiler.mks",
				 "MKS Make configuration aborting."))
			return (0);
		fi
	fi
	if (stat(startup_mk, 0))
		if (!simple_copy(startup_mk, root | "/etc/startup.mks",
				 "MKS Make configuration aborting."))
			return (0);
		fi
	fi
	if (!simple_copy(new_compiler_ccg, compiler_ccg,
			 "MKS Make configuration aborting."))
		return (0);
	fi
	if (!simple_copy(new_startup_mk, startup_mk,
			 "MKS Make configuration aborting."))
		return (0);
	fi
	notify("New versions of\n",compiler_ccg,"and",startup_mk,
		"\nare now installed.\n");
}

function Windows_Configuration()
{
# Determine the directory WINDIR that Windows is installed into.
	windir = "c:/os2/mdos/winos2";
	if (!stat(windir, 1))
		windir = "c:/win";
		if (!stat(windir, 1))
			windir = "c:/windows";
		fi
	fi
	windir = ask(windir,
		     "Where have you installed Microsoft Windows?");
	if (!stat(windir, 1))
		notify("The directory "|windir|" does not exist.",
		       "You must find out where Microsoft Windows",
		       "is installed before you can configure",
		       "Windows for use with MKS Toolkit.");
		return (0);
	fi
	windir = replace(windir, "/", "\\");

# Make sure win.ini exists.
	win_ini = windir | "\\win.ini";
	if (!stat(win_ini, 0))
		notify("The file "|win_ini|" does not exist.",
		       "You must find out where Microsoft Windows",
		       "is installed before you can configure",
		       "Windows for use with MKS Toolkit.");
		return (0);
	fi
# Backup win.ini to win.mks.
	if (!simple_copy(win_ini, windir | "\\win.mks",
	     "Windows with MKS Toolkit configuration aborting."))
		return (0);
	fi

# Make sure mkswin.exe can be found on the floppy drive.
	getdist("/mkswin.exe", 1);
	mkswin_exe = dist | ":/mkswin.exe";
	while (!stat(mkswin_exe, 0)) do
		notify("Can't find " | mkswin_exe,
			syserr(),
		"Ensure you have Volume 1 of MKS Toolkit in "|dist);
	done

# Make sure mkstools.tk can be found on the floppy drive.
	mkstools_tk = dist | ":/mkstools.tk";
	while (!stat(mkstools_tk, 0)) do
		notify("Can't find " | mkstools_tk,
			syserr(),
		"Ensure you have Volume 1 of the Toolkit in "|dist);
	done
# Copy mkstools.tk into WINDIR.
	if (!simple_copy(mkstools_tk, windir | "\\mkstools.tk",
	     "Windows with MKS Toolkit configuration aborting."))
		return (0);
	fi

# Make sure mksgroup.exe can be found.
	mksgroup_exe = replace(root | "/bin/mksgroup.exe", "/", "\\");
	if (!stat(mksgroup_exe, 0))
		notify("You are missing the program",
		       mksgroup_exe,
		       "Please install this program from",
		       "the MKS Toolkit distribution and",
		       "re-run the configuration program.");
		return(0);
	fi

# Execute the program that creates the MKS Tools group under Windows.
	status = exec(mkswin_exe, windir, "mkstools", "tk");
	if (status < 0 || status > 1)
		notify(mkswin_exe |
		    " failed to create the MKS Tools group under Windows.");
		simple_copy(windir | "\\win.mks", win_ini,
			"You'll have to manually copy this file.");
	elif (status == 1)
		notify("You are currently running Windows.",
		   "",
		   "To properly configure Windows for use with",
		   "MKS Toolkit you must exit Windows and",
		   "re-run the configuration program under DOS.",
		   "",
	           "Windows with MKS Toolkit configuration aborting.");
	fi

# Add some passwd entries to allow people to login to windows.
	if (stat(etcpasswd, 0))
		passwd_win  = "win;;1;1;Windows Default Mode;"|root_home|";";
		passwd_wine = "wine;;1;1;Windows Enhanced Mode;"|root_home|";";
		passwd_winr = "winr;;1;1;Windows Real Mode;"|root_home|";";
		passwd_wins = "wins;;1;1;Windows Standard Mode;"|root_home|";";
		real_mode = yes_or_no("n",
				      "Does your version of Windows",
				      "support a real mode?");
		if (real_mode)
			add_entries = yes_or_no("y",
			      "Would you like the following entries added to",
			      "your passwd file?",
			      "",
			      passwd_win,
			      passwd_wine,
			      passwd_wins,
			      passwd_winr,
			      "");
		else
			add_entries = yes_or_no("y",
			      "Would you like the following entries added to",
			      "your passwd file?",
			      "",
			      passwd_win,
			      passwd_wine,
			      passwd_wins,
			      "");
		fi
		if (add_entries)
			if (!search(profile_ksh, 0, "export LOGNAME="))
				append(profile_ksh,
					"export LOGNAME=${LOGNAME:-mks}");
			fi
			qreplace(etcpasswd, "win;", passwd_win);
			qreplace(profile_ksh, "$LOGNAME = 'win'",
	 			 "if [ $LOGNAME = 'win' ];then " |
				      ". $ROOTDIR/etc/dospath;"|
				      "exec '"|windir|"\\win.com'    ;fi");
			qreplace(etcpasswd, "wine;", passwd_wine);
			qreplace(profile_ksh, "$LOGNAME = 'wine'",
	 			 "if [ $LOGNAME = 'wine' ];then " |
				      ". $ROOTDIR/etc/dospath;"|
				      "exec '"|windir|"\\win.com' /e;fi");
			qreplace(etcpasswd, "wins;", passwd_wins);
			qreplace(profile_ksh, "$LOGNAME = 'wins'",
	 			 "if [ $LOGNAME = 'wins' ];then " |
				      ". $ROOTDIR/etc/dospath;"|
				      "exec '"|windir|"\\win.com' /s;fi");
		fi
		if (add_entries && real_mode)
			qreplace(etcpasswd, "winr;", passwd_winr);
			qreplace(profile_ksh, "$LOGNAME = 'winr'",
	 			 "if [ $LOGNAME = 'winr' ];then " |
				      ". $ROOTDIR/etc/dospath;"|
				      "exec '"|windir|"\\win.com' /r;fi");
		fi
	fi
# Ensure that each shell that is started gets a unique history file.
	if (!search(environ_ksh, 0,  ". $ROOTDIR/etc/newhist"))
		append(environ_ksh,
		"if [ _$- != _${-%%*i*} ]; then . $ROOTDIR/etc/newhist ; fi");
	fi
	return(0);
}

function getdist(mesg,vol)
{
	temp = 0;
	while (temp == 0) do
		temp = 1;
		if (dist == 0)
			dist = ask("a",
				   "Enter the drive letter of the disk drive",
				   "that you used to install MKS Toolkit.",
				   "Place Volume " | vol | " of the Toolkit",
				   "in that drive before you press ENTER.");
			dist = substr(dist, 1, 1);
		else
			notify("Insert Volume "|vol|" of MKS Toolkit in "|dist);
		fi
		if (!stat(dist|":"|mesg, 0))
			notify("WARNING",
			       "The diskette in " | dist | ":",
			       "is not Volume " | vol | " of MKS Toolkit",
			       "Please insert Volume " | vol);
			temp = 0;
			dist = 0;
		fi
	done
}

function verifywrite ()
{
	notify("Committing changes to disk.");
	if (rmail != "")
		vwrite(rmail);
	fi
	vwrite(profile_ksh);
	vwrite(environ_ksh);
	vwrite(sysconfig);
	vwrite(autoexec);
	vwrite(etcprofile);
	vwrite(etcpasswd);
	vwrite(etcinittab);
}

function needfile (mesg)
{
	if (!stat(mesg, 0))
		notify("You are missing the program",mesg,
			"Please install this program from",
			"the MKS Toolkit distribution and",
			"re-run the configuration program.");
	fi
}

function qadd(file, mesg, x)
{
	dellines(file, mesg);
	append(file, x);
}
function qreplace(file, mesg, x)
{
	if (!replaceline(file, mesg, x))
		append(file, x);
	fi
}

function simple_copy(file, dest, mesg)
{
	result = cp(file, dest);
	if (!result)
		if (mesg != "")
			notify("Error copying from file " | file,
			       "                to file " | dest,
			       syserr(),
			       "",
			       mesg);
		else
			notify("Error copying from file " | file,
			       "                to file " | dest,
			       syserr());
		fi
	fi
	return (result);
}

function copyfile(file, dest, vol)
{
	getdist(file, vol);
	while (!cp(dist | ":" | file, dest)) do
		notify("Error copying " | file,
			syserr(),
		"Ensure you have Volume " | vol |
		" of the Toolkit in "|install);
	done
	if (hdinstall == 0 && dist == boot)
		notify("Re-insert your DOS boot diskette into "|boot);
	fi
}

function menu()
{
	working = 1;
	while (working) do
		config = select("Select an option:\n",
	    		"  ~< 1 ~>  Add User",
	    		"  ~< 2 ~>  Delete User\n",
	    		"  ~< 3 ~>  Mail Configuration",
	    		"  ~< 4 ~>  MKS Make Configuration",
	    		"  ~< 5 ~>  Windows With MKS Toolkit Configuration\n",
	    		"  ~< 6 ~>  General MKS Toolkit Configuration\n",
	    		"  ~< 7 ~>  Exit Configuration\n");
		if (config == 1)
			Add_User();
		elif (config == 2)
			Delete_User();
		elif (config == 3)
			Mail_Configuration();
		elif (config == 4)
			MKS_Make_Configuration();
		elif (config == 5)
			Windows_Configuration();
		elif (config == 6)
			return (1);
		elif (config == 7)
			verifywrite();
			exit(0);
		fi
	done
}

#
# mainline starts here
#

install = getinstall();
dosver = version();
root = replace(getroot(), "\\", "/");
profile_ksh = root|"/profile.ksh";
environ_ksh = root|"/environ.ksh";

product_cfg = root|"/etc/product.cfg";
if (!stat(product_cfg, 0) ||
    !search(product_cfg, 0, "MKS Toolkit for "|toolkit_os))
	notify("You must install MKS Toolkit before you",
	       "configure it.  See the Installation Manual.");
	exit(0);
fi

root_home = root;
if (length(root_home) == 2 && substr(root_home, 2, 1) == ":")
	root_home = root_home | "/";
fi
etcinittab = replace(root | "/etc/inittab", "//", "/");
etcpasswd = replace(root | "/etc/passwd", "//", "/");
etcprofile = replace(root | "/etc/profile.ksh", "//", "/");
initroot = replace(root, "/", "\\");
tmpdir = replace (gettmp(), "\\", "/");
comspec = replace(getcomspec(), "\\", "/");
path = getenv("PATH");
path = replace (path, "\\", "/");

hdinstall = 0;
if (yes_or_no("y",
	"Most people boot their DOS system from a hard disk.",
	"However, it is possible to boot DOS from a diskette,",
	"and then run from a hard disk.\n",
	"Do you boot from your hard disk?"))
		hdinstall = 1;
fi

config = 0;
while (config == 0) do
	if (hdinstall == 1)
		if (substr(root, 2, 1) != ":")
			boot = ask("c",
				   "Enter the drive letter of the",
				   "hard disk from which you boot.");
		else
			boot = ask(substr(root, 1, 1),
				   "Enter the drive letter of the",
				   "hard disk from which you boot.");
		fi
	else
		boot = ask("a",
			"Enter the drive letter of the disk",
			"drive that is used to boot DOS. You",
			"should load your normal DOS boot diskette",
			"in that drive before you press ENTER.");
	fi
	autoexec = boot | ":/autoexec.bat";
	sysconfig = boot | ":/config.sys";	# when it works

	config = 1;
	if (!stat(sysconfig, 0) && !yes_or_no("y",
		"Device "|boot|": does not have a \"config.sys\" file.",
		"Do you want to use this device?"))
		config = 0;
	fi
	if (config == 1 && !stat(autoexec, 0) && !yes_or_no("y",
		"Device " | boot |": does not have an \"autoexec.bat\" file.",
		"Do you want to use this device?"))
		config = 0;
	fi
done

menu();

if (!yes_or_no("y",
	"WARNING",
	"While configuring MKS Toolkit, you may make changes",
	"that cause your current DOS system to fail to boot.",
	"(For example, you may incorrectly specify a new DOS SHELL.)",
	"Ensure that you have a DOS boot diskette, so that you",
	"can reboot DOS if necessary.  See the instructions",
	"in the Installation Manual for details on creating ",
	"a DOS boot diskette.",
	"",
	"Do you have a DOS boot diskette readily available?"))
	notify("When you are done, simply re-run \"config.exe\".");
	exit(0);
fi

if (!stat(root|"/bin/sh.exe", 0))
	notify("Cannot find MKS KornShell",
		root|"/bin/sh.exe",
	"You must install MKS Toolkit before you can configure it.",
	"See the instructions in the Installation Manual.");
	exit(0);
fi

# 1 -- no shell
# 2 -- no shell, but autoexec.bat runs sh -L
# 3 -- shell=sh -L
# 4 -- shell=init
# 5 -- shell=init, but /etc/inittab runs 'respawn;bin/sh.exe'
oldcfg = senseconfig(sysconfig, autoexec, etcinittab);
if (oldcfg == 1)
	config = 0;
else
	config = oldcfg;
	if (config == 2)
		x = "call MKS KornShell from command.com, in autoexec.bat.";
	elif (config == 3)
		x = "use MKS KornShell instead of command.com.";
	elif (config == 4)
		x = "use init to allow logging into KornShell or command.com.";
	elif (config == 5)
		x = "use init to run TSRs, and then run the KornShell.";
	fi
	if (yes_or_no("y",
		"You seem to already have MKS Toolkit configured",
		"to " | x,
		"This is configuration "|config|
		".",
		"Do you want to change this configuration?"))
		config = 0;
	else
		oldcfg = 0;		# keep current config
	fi
fi

while (config == 0) do
	config = select("Select a configuration option:\n",
		"  ~< 1 ~>  Using MKS Toolkit commands from command.com,",
		"       when you expect to rarely use MKS KornShell.",
		"  ~< 2 ~>  Use command.com to run the KornShell from",
		"       autoexec.bat while leaving command.com in",
		"       memory (for DOS 2.x.)",
		"  ~< 3 ~>  Replace command.com completely with MKS",
		"       Kornshell, so that your DOS shell is always",
		"       the KornShell.",
		"  ~< 4 ~>  Use init to allow logging in to either shell",
		"       and allow multiple login accounts on one machine.",
		"  ~< 5 ~>  Use init to load TSRs, and then run MKS",
		"       KornShell.");
	if (dosver < 3 && config > 2)
		notify("You have an older version of DOS",
		       "(pre-release 3.1) which cannot run",
		       "this configuration.",
		       "Select one of the other configuration options.");
		config = 0;
	fi
	if (config > 3)
		needfile(root | "/etc/init.exe");
		needfile(root | "/bin/login.exe");
	fi
done

if (config < 3)
	cfile = autoexec;
else
	cfile = etcprofile;
fi

mesg = findtoken(sysconfig,"shell");	# find shell used in sysconfig
if (oldcfg != 0 && config < 3 && mesg && !index(mesg, "command.com"))
	notify("Your "|sysconfig|
	       " has a setting for SHELL",
	       mesg,
	       "which is not command.com. This",
	       "configuration requires that you run",
	       "command.com as your SHELL. Your old",
	       "SHELL= line will be deleted from "|sysconfig);
	if (!dellines(sysconfig, "shell"))
		notify("removal failed!",
		       "Remove the SHELL= line from",sysconfig,
		       "manually after the configuration is done");
	fi
fi

mesg = findtoken(sysconfig, "break");
if ((!mesg || caselesscmp(mesg,"off")) && yes_or_no("y",
              "We recommend that you set BREAK=ON",
              "on your DOS system, so that you can use",
              "Ctrl-Break to break-out of programs that",
              "are not currently doing device I/O.",
              "Do you want to add the line",
              "break=on",
              "to your " |sysconfig|" file?"))
	if (mesg)
		dellines(sysconfig, "break");
	fi
	append(sysconfig, "break=on");
fi

mesg = findtoken(sysconfig, "files");
if ((!mesg || mesg < 20) && yes_or_no("y",
              "We recommend that you allow at least",
              "20 open files on your DOS system.   ",
              "Do you want to add a line to your",
              "\"config.sys\" allowing 20 open files?"))
	if (mesg)
		dellines(sysconfig, "files");
	fi
	append(sysconfig, "files=20");
fi

ulimit = 0;
if (config == 3 && yes_or_no("n",
	"Terminate-and-Stay-Resident (TSR) programs",
	"must be run from the KornShell in this",
	"configuration. This means that some",
	"memory must be set aside in the KornShell",
	"for any TSRs. Since the KornShell can grow",
	"in memory size as you define new strings,",
	"aliases, and functions, this set-aside memory",
	"will be used by the shell, after which these",
	"TSRs can be loaded.",
	"Examples of TSR programs are:",
	"APPEND (in DOS 3.3),",
	"IPX for Novell NetWare,",
	"& SideKick from Borland", 
	"Do you plan to run any TSRs from the KornShell",
	"at this time?"))
		ulimit = 1;
fi
if ((config == 2 || config > 3) && yes_or_no("n",
	"Terminate-and-Stay-Resident (TSR) programs should",
	"be run BEFORE the KornShell starts, so that the",
	"KornShell will be loaded in memory AFTER the TSR.",
	"Since the KornShell can grow in memory as you",
	"define new strings, aliases, and functions, it is",
	"best to have the TSRs in DOS memory before the",
	"KornShell starts.",
	"Examples of TSR programs are:",
	"APPEND (in DOS 3.3),",
	"IPX for Novell NetWare,",
	"& SideKick from Borland", 
	"If you want to run a TSR from the KornShell,",
	"you can tell the KornShell to set aside memory",
	"for its own use, and leave the rest of memory",
	"for TSRs and other programs. This does waste",
	"some space, since the set-aside memory is",
	"reserved for the KornShell.",
	"Do you plan to run any such TSRs at this time?"))
		ulimit = 1;
fi
if (ulimit == 1)
	x = 0;
	while (x == 0) do
		x = 0 + ask("48",
	"Enter the amount of memory you want",
	"to set aside for the KornShell.",
	"This size is in K (1024bytes),",
	"and cannot be greater than 64,",
	"or less than 22. (The shell needs",
	"at least 22K for itself)",
	"If this number is too small, the",
	"KornShell can run out of memory to store",
	"strings, functions, and aliases.");
		if (x < 22 || x > 64)
			notify("Bad value", x,
				"for ulimit; reenter");
			x = 0;
		else
			ulimit = x;
		fi
	done
fi

# Set up timezone
tz = getenv("TZ");
if (tz == "")
	tz = ask("EST0EDT",
    "Enter your timezone correction code.",
    "First letters indicate the timezone",
    "abbreviation (eg EST). The last letters",
    "indicate the daylight savings abbreviation",
    "(eg EDT). The last letters can be left off",
    "to disable daylight savings corrections.",
    "The number indicates hours west of Greenwich",
    "(eg 5 for EST). These numbers can have a leading",
    "hyphen (-) for times east of Greenwich,",
    "such as MESZ-1 for parts of Western Europe",
    "Minutes are optionally indicated after a",
    "trailing colon (:) (eg NST3:30NDT for Newfoundland).",
    "To use the local (hardware) time, set the hours to 0 (eg EST0).");
fi

if (path == "")
	path = root|"/bin;"|substr(root, 1, 1)|":/;";
	notify("You do not have a search PATH defined.",
	       "PATH is used to name directories to be searched",
	       "for executable programs.  Your new PATH is:",
	       path);
elif (!inpath(path, root | "/bin"))
	notify("Your search PATH will be augmented to include",
		root|"/bin");
	path = root|"/bin;"|path;
fi

if (yes_or_no("y",
	"You may already have commands in your path which",
	"could be confused with MKS commands.",
	"Do you want to check for possible executable",
	"conflicts? (This may take a while)."))
	checkpath(root | "/bin", path);
fi

# ensure glob is available
glob = root | "/etc/glob.exe";
globe = getenv("GLOB");
globe = replace  (globe, "\\", "/");
#globe = replace (getenv("GLOB"), "\\", "/");

if (stat(glob, 0) == 0)			# no /etc/glob
	if (globe != "")		# have GLOB
		if (stat(globe, 0) == 0)# but it doesn't exist!
			if (yes_or_no("y",
		"Wild card expansion of MKS Toolkit command line",
		"arguments requires the Toolkit program glob.exe.",
		"This program is not in its usual place",
		glob,
		"Toolkit commands look for glob.exe based on the",
		"setting of the environment variable GLOB; however,",
		"your value of GLOB points to a non-existent program",
		"called ",globe,
		"Would you like to re-install glob.exe in "|glob|"?"))
				copyfile("/etc/glob.exe",
					root | ":/etc/glob.exe", 1);
				globe = "";
			else
				notify("You cannot expand command line",
				       "arguments from DOS command.com",
				       "until you correctly install",
				       globe);
			fi
		else			# GLOB exists and works
			notify("An assignment to GLOB will be made in "|cfile);
		fi
	elif (yes_or_no("y",			# no /etc/glob or GLOB
		"Wild card expansion of MKS Toolkit command",
		"lines, when using command.com, require the",
		"program glob.exe. This program is not in its",
		"usual place",
		glob,
		"Would you like to install glob.exe in its",
		"usual place?"))
		copyfile("/etc/glob.exe", root | "/etc/glob.exe",1);
	else
		notify("You cannot expand command line",
		       "arguments from DOS command.com",
		       "until you correctly install",
		       glob);
	fi
fi

# Running from command.com -- change autoexec.bat
if (config < 3)
	notify("These variables will be assigned in your \"autoexec.bat\"",
	       "file, but only if they are not already set:",
	       "ROOTDIR",
	       "TMPDIR",
	       "PATH",
	       "TZ",
	       "and (optionally)",
	       "GLOB");
	if (path != "")
		if (config == 1)
			qreplace(autoexec, "PATH=",
				 "set PATH=" | replace(path, "/", "\\"));
		else
			qreplace(autoexec, "PATH=",
				 "set PATH=" | path);
		fi
	fi
	qreplace(autoexec, "ROOTDIR=", "set ROOTDIR=" | root);
	qreplace(autoexec, "TMPDIR=", "set TMPDIR=" | tmpdir);
	if (globe != "")
		qreplace(autoexec, "GLOB=", "set GLOB=" | globe);
	fi
	qreplace(autoexec, "TZ=", "set TZ=" | tz);
	if (config == 1)
		if (oldcfg == 2)
			notify("Your older configuration runs the KornShell",
			       "from "|autoexec,
			       "The line that does this will be removed.");
			if (!dellines(autoexec,"sh -L","sh.exe -L"))
				notify("Removal of SH -L",
				       "FAILED!",
			         "Remove the line running the KornShell from",
				       autoexec,
				       "by hand, after this program is done.",
				       "The line will appear as",
				       "sh -L");
			fi
		fi
		verifywrite();
		if (yes_or_no("y",
		"MKS Toolkit commands have the same name",
		"as DOS commands built into command.com.",
		"By patching command.com, you can use the",
		"Toolkit versions, which do similar things",
		"in a more powerful way.",
		"Would you like to patch command.com?"))
			notify("The following commands will be patched",
			"cd","date","echo", "mkdir","rmdir","time");
			if (patch())
				notify("Your previous command.com has been saved",
				"as \"command.mks\".");
			fi
		fi
		notify("This configuration is now complete.",
		       "You can invoke MKS Toolkit commands from",
		       "command.com, just like any other DOS command.");
		exit(0);
	fi
	notify("The KornShell will be run as the last",
	       "command in "|autoexec,
	       "If you run any Terminate-and-Stay-Resident",
	       "(TSR programs) from "|autoexec|",",
	       "they should be run before the KornShell");
	dellines(autoexec, "Run the shell last",
		 "sh -L", "sh.exe -L");
	append(autoexec, "rem Run the shell last",
	       "sh -L -0 "|root|"/bin/sh.exe -R 0");
fi

# Changes to etcprofile
if (!stat(etcprofile, 0))
	notify("A new "|etcprofile|" will be created");
fi
if (path != "")
	qreplace(etcprofile, "PATH=", "export PATH=\"" | path | "\"");
fi
dellines(etcprofile, "TMPDIR=");
qreplace(etcprofile, "TMPDIR:=",
		      "export TMPDIR; : ${TMPDIR:="| tmpdir |"}");
dellines(etcprofile, "ROOTDIR=");
qreplace(etcprofile, "ROOTDIR:=",
		     "export ROOTDIR; : ${ROOTDIR:="| root |"}");
if (globe != "")
	qreplace(etcprofile, "GLOB=", "export GLOB=" | globe);
fi
dellines(etcprofile, "TZ=");
qreplace(etcprofile, "TZ:=",
		     "export TZ; : ${TZ:="| tz |"}");
dellines(etcprofile, "SHELL=");
qreplace(etcprofile, "SHELL:=",
		     "export SHELL; : ${SHELL:=$ROOTDIR/bin/sh.exe}");
dellines(etcprofile, "COMSPEC=");
qreplace(etcprofile, "COMSPEC:=",
		     "export COMSPEC; : ${COMSPEC:='"|
					  replace(comspec, "/", "\\") |"'}");
if (ulimit != 0)
	qadd(etcprofile, "ulimit", "ulimit -d " | ulimit);
else
	dellines(etcprofile, "ulimit");
fi
qreplace(etcprofile, "/etc/motd","cat -s " | root | "/etc/motd");
	
if (config == 2)
	verifywrite();
	notify("This configuration of MKS Toolkit is now complete.",
	       "When you restart DOS, it will run \"command.com\"",
	       "which will run the commands in autoexec.bat, and",
	       "then execute MKS KornShell. You should then see",
	       "the KornShell prompt, which is simply a single",
	       "dollar sign ($).");
	exit(0);
fi

# config 3 sh -L
if (config == 3)
	qreplace(sysconfig,
	     "shell=",
	     "shell="|initroot|"\\bin\\sh.exe -L -0 "|root|"/bin/sh.exe -R 0");
	if (substr(root,1,1) != boot && !stat(boot|":/etc/profile.ksh", 0))
		notify("Since your MKS Toolkit ROOTDIR ",root,
		       "is NOT the same as your DOS boot device "|boot,
		       boot|":/etc/profile.ksh will be created to",
		       "redirect the shell to your MKS Toolkit root device.");
		if (!stat(boot|":/etc", 1))
			mktree(boot|":/etc");
		fi
		append(boot|":/etc/profile.ksh",
		       "export ROOTDIR="|root,
		       "export HOME="|root,
		       "cd $HOME",
		       ". "|root|"/etc/profile.ksh");
		vwrite(boot|":/etc/profile.ksh");
	fi
	verifywrite();
	notify("This configuration of MKS Toolkit is now",
	       "complete. When you restart DOS, it will run",
	       "MKS KornShell instead of command.com. You should",
	       "see the KornShell prompt which is simply a single",
	       "dollar sign ($.  Since the KornShell is run",
	       "as sh -L, it will act as a login shell on UNIX",
	       "systems; this means, in particular, that the",
	       "commands in " | etcprofile,
	       "will be executed before you see the prompt. Note",
	       "that there is no place to run any TSRs other than",
	       "from the KornShell; these can be executed from",
	       etcprofile,
	       "by editing that file to add those commands.");
	exit(0);
fi

# config 4 & 5 => UNIX-style init
if (!stat(etcinittab, 0))
	if (yes_or_no("y",
		"You are missing the file",
		etcinittab,
		"Do you want to copy it from",
		"MKS Toolkit distribution?"))
		copyfile("/etc/inittab", etcinittab, 1);
	else
		notify("You do not have:",
		       etcinittab,
		       "so a default will be created",
		       "This file is used by init to run",
		       "your TSRs and login.");
		append(etcinittab, "rc;0;wait;bin/sh.exe etc/rc");
		if (config == 4)
			append(etcinittab,
			       "co;0;respawn; ENVSIZE=512 bin/login.exe");
		else
			append(etcinittab,
			       "co;0;respawn;bin/sh.exe -L");
		fi
	fi
elif (oldcfg != 0)
	if (config == 4)
		if (!search(etcinittab,1,"co;0;respawn; ENVSIZE=512 bin/login.exe"))
			notify("A line will be added to " | etcinittab |
                               " to run login.exe");
			qadd(etcinittab,
			     "respawn",
			     "co;0;respawn; ENVSIZE=512 bin/login.exe");
		fi
	else
		if (!search(etcinittab,1,"co;0;respawn;bin/sh.exe -L"))
			notify("A line will be added to " | etcinittab |
			       " to run sh.exe -L");
			qadd(etcinittab,
			     "respawn",
			     "co;0;respawn;bin/sh.exe -L");
		fi
	fi
fi
if (config == 4)
	if (!stat(etcpasswd, 0))
		notify("You are missing the file:",
		       etcpasswd,
		       "A default file will be created to",
		       "allow you to login as either",
		       "\"com\", receiving "|comspec|" as your shell, or",
		       "\"mks\", receiving MKS KornShell as your shell.");
		append(etcpasswd,
		       "com;;0;0;command.com (DOS shell);"|root_home|";",
		       "mks;;1;1;MKS KornShell (DOS);"|root_home|";"|
			root|"/bin/sh.exe -0 "|root|"/bin/sh.exe -R 0");
		profile_ksh = root|"/profile.ksh";
		if (!search(profile_ksh, 0, "$LOGNAME = 'com'"))
			if (!search(profile_ksh, 0, "export LOGNAME="))
				append(profile_ksh,
					"export LOGNAME=${LOGNAME:-mks}");
			fi
			append(profile_ksh,
			       "if [ $LOGNAME = 'com' ] ; then",
			       "	. $ROOTDIR/etc/dospath",
        		       "	export PROMPT='$p$g'",
        		       "	unset SHELL",
        		       "	exec $COMSPEC /e:1024",
			       "fi");
		fi
	elif (!search(etcpasswd, 1, "mks"))
		notify("An entry for \"mks\" could not be found in",
		       etcpasswd,
		       "An account will be added to let you login as",
		       "\"mks\", receiving MKS KornShell as your shell.");
		append(etcpasswd,
		       "mks;;1;1;MKS KornShell (DOS);"|root_home|";"|
			root|"/bin/sh.exe -0 "|root|"/bin/sh.exe -R 0");
	fi
fi
if (oldcfg != 0)
	dellines(sysconfig,"shell=");
	if (!append(sysconfig, "shell="|initroot|"\\etc\\init.exe -R "| root))
		notify("Could not append line",
		       "shell="|initroot|"\\etc\\init.exe -R "|root,
		       "to your "|sysconfig|
		       " file.",
		       "You will have to add this line manually yourself");
	fi
fi

verifywrite();
if (config == 4)
	notify("Your configuration of MKS Toolkit is",
	       "complete. When you reboot DOS from now on,",
	       "it will run "|root|"/etc/init.exe which will execute",
	       "the commands from "|root|"/etc/inittab.",
	       "The default is for inittab to run the commands",
	       "in "|root|"/etc/rc.ksh and then to invoke "|root|"/bin/login.",
	       "You will see a prompt",
	       "login:",
	       "to which you should type",
	       "mks",
	       "to start running a KornShell. If you then type",
	       "\"exit\", your shell will finish, and init will",
	       "start a new login (This is exactly how UNIX",
	       "systems operate).");
else
	notify("Your configuration of MKS Toolkit is",
	       "complete. When you reboot DOS from now on,",
	       "it will run "|root|"/etc/init.exe which will execute",
	       "the commands from "|root|"/etc/inittab. In this",
	       "configuration, "|root|"/bin/sh will be run from init,",
	       "so you will see the KornShell prompt",
	       "$",
	       "when you restart your machine.");
fi

if (config == 4)
	x = "Remember to login as \"mks\" to use the KornShell";
else
	x = "You should startup into the KornShell";
fi

while (1) do
	notify("Press Control-ALT-DEL to reboot your system",
	       "or press Ctrl-BREAK to interrupt this program", x);
done

